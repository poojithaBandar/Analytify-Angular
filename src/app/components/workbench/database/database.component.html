<app-page-header title="Database" moduleId="datasource" title1="Home" activeitem="Database"></app-page-header>

<div class="main-container container-fluid TopHeader">

    @if(tableJoiningUI){
        <div class="main-container container-fluid">
    <div class="row">
        <div class="col-xxl-2 col-xl-2 col-lg-2 col-md-2 p-1 card mb-3 mt-1 left-sidebar border">
            <div class="p-2 br-0 mb-0  border-bottom d-block">
                <div class="d-flex align-items-center justify-content-between ">
                    <h6 class="mb-0">Connections</h6>
                    <a ngbTooltip="Click to connect multi datasources" (click)="goToConnections()"><span  class="add-txt text-info">Add</span></a>
                </div>
                <p class=" mb-0" [ngbTooltip]="hostName?.length > 15 ? hostName : null">{{hostName?.length > 15 ? (hostName| slice:0:15)+'...':hostName}}</p>
            </div>
            <div class="mb-0 p-2 br-0 border-bottom">
                <h6 class="mb-0">Database</h6>
                <p class="mb-0" [ngbTooltip]="databaseName?.length > 15 ? databaseName : null">{{databaseName?.length > 15 ? (databaseName| slice:0:15)+'...':databaseName}}</p>
            </div>
            <!-- <div class="card mb-0 br-0">
            </div> -->
            <div class="mb-0 br-0 pt-0 schema-table-height" >
                <div class="mb-0 p-0 py-1 border-bottom-0">
                    <div class="input-group ">
                        <input type="text" class="form-control border-end-0" [placeholder]="canSearchTablesInSemanticLayer ? 'Search Tables' : 'Search disabled on this account'"
                            [(ngModel)]="searchTables" (keydown.enter)="canSearchTablesInSemanticLayer ? getSchemaTablesFromConnectedDb() : null">
                        <button [disabled]="!canSearchTablesInSemanticLayer" type="button" aria-label="button" (click)="getSchemaTablesFromConnectedDb()"
                            class="btn input-group-text btn-primary tx-fixed-white border-start-0">
                            <i class="fe fe-search" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
                
                <div class="card-body p-0 overflow-auto">
                    <div ngbAccordion [closeOthers]="true" class="accordion" id="accordionExample">
                        <div *ngFor="let menu of schematableList; let i = index" ngbAccordionItem [collapsed]="i !== 0"
                            class="accordion-item">
                            <div ngbAccordionHeader class="accordion-header" id="heading{{i}}">
                                <button ngbAccordionButton class="accordion-button p-3 fw-500" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapse" aria-expanded="true"
                                    aria-controls="collapse">
                                    <h6 class="mb-0 text-truncate">{{ menu.schema }}</h6>
                                </button>
                            </div>
                            <div ngbAccordionCollapse id="collapse{{i}}" class="accordion-collapse collapse"
                                [class.show]="i === 0" aria-labelledby="heading" data-bs-parent="#accordionExample">
                                <div class="accordion-body p-1 overflow-auto database-dropdown database-accordion-height" ngbAccordionBody>
                                    <!-- <button type="button" data-bs-dismiss="alert" aria-label="Close" class="btn-close mt-0">
                                <i class="bi bi-arrows-fullscreen drilldown-icon"></i>
                            </button> -->
                                    <ng-template>
                                        <div class="sub-menu" cdkDropList #originList="cdkDropList"
                                            [cdkDropListData]="menu.tables" [cdkDropListConnectedTo]="[destinationList]"
                                            (cdkDropListDropped)="drop($event)">
                                            <div *ngFor="let submenu of menu.tables"
                                                class="sub-menu-item example-box subMenuFlex p-2 border rounded-3" cdkDrag [cdkDragDisabled]="!dragTablestoSemanticLayer">
                                                <i class="fa fa-table table-icon-p"></i>
                                                <span [ngbTooltip]="submenu.table.length > 15 ? submenu.table : null">{{submenu.table ? (submenu.table.length > 15 ? (submenu.table| slice:0:15)+'...':submenu.table) : ''}}</span>
                                            </div>
                                        </div>
                                    </ng-template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div class="col-xl-10 col-md-12 p-1">
            <div class=" p-0 ">
                <div class="col-xl-12 col-md-12 p-0">
                    <div class="card mb-0 p-3 border bg-light database-title-card">
                        <div class="flex-grow-1 ">
                            <input type="text" [(ngModel)]="saveQueryName" (change)="markDirty()" placeholder="Title"
                                aria-label="Sheet" class="form-control">
                        </div>
                        <div class="right">
                            @if(draggedtables?.length){
                            <a data-bs-effect="effect-super-scaled" data-bs-toggle="modal"
                                (click)="openSuperScaled(applyFiltersModal);getFilteredList('fromTableJoinig')"
                                class="modal-effect btn btn-primary ms-1">
                                <i class="fa fa-filter"></i> Apply Filters
                            </a>
                            }
                            <app-insights-button *ngIf="sheetCustmSqlDisable" [buttonName]="'Custom SQL'" [classesList]="'btn btn-blue-light ms-1'"
                                [previledgeId]="54" [isBtn]="true" (btnClickEvent)="custmSqlUI()"
                                [isIcon]="false"></app-insights-button>
                            <app-insights-button [classesList]="'viewQueryImg'" [previledgeId]="72"
                                [gotoSheetButton]="draggedtables?.length === 0" [isBtn]="true" [isIcon]="false"
                                (btnClickEvent)="viewQuery(viewQueryModal)" [toolTip]="' View Query'"
                                [imageUrl]="'./assets/images/icons/view-query.png'">
                            </app-insights-button>
                            <!-- <a class="btn btn-blue-light m-1" (click)="customSql=true;tableJoiningUI=false">New Custom SQL</a> -->
                        </div>
                    </div>
                    <div class="d-flex border">
                        <div class="col-xxl-6 col-xl-6 col-lg-6 col-md-6 p-0">
                            <div class="card card-body databse-T-H mb-0 br-0 p-0">
                                <div class="card-body example-list-drop  mb-0" cdkDropList
                                    #destinationList="cdkDropList" [cdkDropListData]="draggedtables"
                                    (cdkDropListDropped)="tableCustomJoinError ? '' : drop($event)">
                                    @for(item of draggedtables;track $index){
                                        <div class="example-box p-2 border border-dark-subtle rounded-3 mb-1 cursor-auto" [attr.title]="(item.alias?.length > 12 || item.schema?.length > 12) ? (item.alias + ' (' + item.schema + ')') : null" >{{item.alias | slice:0:16}}({{item.schema | slice:0:12}})
                                        <!-- <i class="ri-delete-bin-7-line"  data-bs-toggle="tooltip" (click)="onDeleteItem($index)" ngbTooltip="delete table"></i> -->

                                        <a aria-label="anchor" (click)="onDeleteItem($index,item.alias)" [style.pointer-events]="deleteTablesFromSemanticLayer ? 'auto' : 'none'"
                                            class="btn btn-icon btn-sm btn-danger-light btn-wave waves-effect waves-light">
                                            <i class="ri-delete-bin-7-line" ngbTooltip="Delete database"></i>
                                        </a>
                                    </div>
                                    <!-- <a aria-label="anchor" (click)="deleteDbConnection(database.database_id)" class="btn btn-icon btn-sm btn-danger-light btn-wave waves-effect waves-light">
                                <i class="ri-delete-bin-7-line" ngbTooltip="Delete database"></i>
                        </a> -->
                                    }
                                    @if(!draggedtables?.length){
                                    <h6 class="fs-12 mt-2 mb-0 drag-txt">Drag tables here</h6>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="col-xxl-6 col-xl-6 col-lg-6 col-md-6 p-0">
                            <div class="card databse-T-H mb-0 br-0">
                                <div class="card-body overflow-auto border-start" >
                                    @if(relationOfTables.length){
                                    <ul class="tags">
                                        @for(relation of tableJoiningList;track relation;let i = $index){
                                        <!-- <li class="tag rounded-pill bg-primary tx-fixed-white alert" id="row16">
                                                                                <span class="tag-avatar avatar avatar-sm bg-white text-primary rounded-pill"><i class="fa fa-circle" ></i>
                                                                                    <i class="fa fa-circle" ></i></span>
                                                                                    {{relation}}
                                                                                <a class="tag-addon rounded-pill bg-white-transparent" data-bs-dismiss="alert" (click)="deleteJoiningRelation(i)" aria-hidden="true"><i class="fe fe-x"></i></a>
                                                                            </li> -->
                                        <div class="dropdown" ngbDropdown  autoClose="outside">
                                            <li class="tag rounded-pill bg-primary alert" id="row16" style="color: #fff;" (click)="searchTermT1 = '';relation.searchTermT2='';filterColumnsT1();filterColumnsT2(relation)">
                                                <span ngbDropdownToggle data-bs-toggle="dropdown" class="dropdown-toggle" *ngIf="relation.join === 'full Outer'"
                                                    ngbTooltip="Full Outer Join" class="tag-avatar avatar avatar-sm bg-white text-primary rounded-pill">
                                                    <img src="./assets/images/charts/full-outer.png" class="rounded-2 mrk-t  chart-icon active ms-2 join-icon-p">
                                                </span>
                                                <span ngbDropdownToggle data-bs-toggle="dropdown" class="dropdown-toggle" *ngIf="relation.join === 'Right'"
                                                    ngbTooltip="Right Join" class="tag-avatar avatar avatar-sm bg-white text-primary rounded-pill">
                                                    <img src="./assets/images/charts/right-join.png" class="rounded-2 mrk-t  chart-icon active ms-2 join-icon-p">
                                                </span>
                                                <span ngbDropdownToggle data-bs-toggle="dropdown" class="dropdown-toggle" *ngIf="relation.join === 'Left'"
                                                    ngbTooltip="Left Join" class="tag-avatar avatar avatar-sm bg-white text-primary rounded-pill">
                                                    <img src="./assets/images/charts/left-join.png" class="rounded-2 mrk-t  chart-icon active ms-2 join-icon-p">
                                                </span>
                                                <span ngbDropdownToggle data-bs-toggle="dropdown" class="dropdown-toggle" *ngIf="relation.join === 'inner'"
                                                    ngbTooltip="Inner Join" class="tag-avatar avatar avatar-sm bg-white text-primary rounded-pill">
                                                    <img src="./assets/images/charts/inner-join.png" class="rounded-2 mrk-t  chart-icon active ms-2 join-icon-p">
                                                </span>
                                                <p class="d-flex align-items-center">{{relation.table1}} : {{relation.table2}}</p>
                                                                                    <!-- <a class="tag-addon rounded-pill bg-white-transparent"
                                                                                        data-bs-dismiss="alert" (click)="deleteJoiningRelation(i)"
                                                                                        aria-hidden="true" ><i class="fe fe-x"></i></a> -->
                                            </li>
                                            <div class="dropdown-menu size-dropdown Semantic-layer-card" ngbDropdownMenu autoClose="outside" >
                                                <h6 class="mb-0 p-1">Join</h6>
                                                <div class="row px-3">
                                                    <div class="col-3 border px-2 cursor-pointer text-center" (click)="joinTypes[i] = 'inner';" [ngClass]="joinTypes[i] == 'inner' ? 'btn-blue-light':''">
                                                        <img src="./assets/images/charts/inner-join.png" class="w-7 join-icon-p">
                                                        <p class="Semantic-text mb-0">Inner</p>
                                                    </div>
                                                    <div class="col-3 border px-2 cursor-pointer text-center" (click)="joinTypes[i] = 'Left';" [ngClass]="joinTypes[i] == 'Left' ? 'btn-blue-light':''">
                                                        <img src="./assets/images/charts/left-join.png" class="w-7 join-icon-p">
                                                        <p class="Semantic-text mb-0">Left</p>
                                                    </div>
                                                    <div class="col-3 border px-2 cursor-pointer text-center" (click)="joinTypes[i] = 'Right';" [ngClass]="joinTypes[i] == 'Right' ? 'btn-blue-light':''">
                                                        <img src="./assets/images/charts/right-join.png" class="w-7 join-icon-p">
                                                        <p class="Semantic-text mb-0">Right</p>
                                                    </div>
                                                    <div class="col-3 border px-2 cursor-pointer text-center" (click)="joinTypes[i] = 'full Outer';" [ngClass]="joinTypes[i] == 'full Outer' ? 'btn-blue-light':''">
                                                        <img src="./assets/images/charts/full-outer.png" class="w-7 join-icon-p">
                                                        <p class="Semantic-text mb-0">Full Outer</p>
                                                    </div>
                                                </div>
                                               
                                                    <div class="row px-3">
                                                        <div class="col border Semantic-bg p-1">
                                                            <p class="Semantic-header mb-0 text-truncate">Data Source</p>
                                                        </div>
                                                        <div class="col border Semantic-bg p-1">
                                                            <p class="Semantic-header mb-0 text-truncate"></p>
                                                        </div>
                                                        <div class="col border Semantic-bg p-1">
                                                            <p class="Semantic-header mb-0 text-truncate">{{relation.table2}}</p>
                                                        </div>
                                                        <div class="col border Semantic-bg p-1">
                                                            <p class="Semantic-header mb-0 text-truncate"></p>
                                                        </div>
                                                    </div>
                                                   
                                                    @for(condition of relation?.conditions;track condition;let conditionIndex = $index ){
                                                        <div class="row px-3">
                                                        <div class="col border p-1 text-center">
                                                            <div ngbDropdown class="btn-group dropdown">
                                                                <button type="button" ngbDropdownToggle data-bs-toggle="dropdown"
                                                                    aria-expanded="false" class="dropdown-toggle btn btn-primary-light"> {{(condition.firstcolumn ?
                                                                    condition.firstcolumn:'Select Column') | slice:0:13}}</button>
                                                                <ul ngbDropdownMenu class="dropdown-menu drpdwnhgt">
                                                                    <li>
                                                                        <input class="form-control" type="text" [(ngModel)]="searchTermT1" (input)="filterColumnsT1()"
                                                                            placeholder="Search columns..." />
                                                                    </li>
                                                                    @for(table of filteredTablesT1;track table;let nestedIndex = $index){
                                                                    @if(nestedIndex <= i ){ <li class="dropdown-plus-title">
                                                                        {{ table.schema }}.{{ table.alias }}
                                                                        </li>
                                                                        @for(column of table.columns;track column){
                                                                        <li>
                                                                            <a ngbDropdownItem class="dropdown-item"
                                                                                (click)="condition.firstcolumn = column.column;condition.table1= table.alias;relation.table1 = table.alias;searchTermT1='';filterColumnsT1();">{{
                                                                                column.column }}</a>
                                                                        </li>
                                                                        }
                                                                        }
                                                                        }
                                                                </ul>
                                                            </div>
                                                        </div>
                                                        <div class="col border p-1 text-center">
                                                            <div ngbDropdown class="btn-group dropdown">
                                                                <button type="button" ngbDropdownToggle data-bs-toggle="dropdown" aria-expanded="false" [ngbTooltip]="condition.firstcolumn + condition.operator + condition.secondcolumn "
                                                                    class="dropdown-toggle btn btn-primary-light">{{ condition.operator ?
                                                                    condition.operator : 'Operator' }}</button>
                                                                <ul ngbDropdownMenu class="dropdown-menu" style="background-color: #ffffff;">
                                                                    <li><a class="dropdown-item" (click)="condition.operator = '='" ngbDropdownItem>=</a></li>
                                                                    <li><a class="dropdown-item" (click)="condition.operator = '>'" ngbDropdownItem>></a></li>
                                                                    <li><a class="dropdown-item" (click)="condition.operator = '<'" ngbDropdownItem><</a>
                                                                    </li>
                                                                    <li><a class="dropdown-item" (click)="condition.operator = '>='" ngbDropdownItem>>=</a></li>
                                                                    <li><a class="dropdown-item" (click)="condition.operator = '<='" ngbDropdownItem>
                                                                            <=</a>
                                                                    </li>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                        <div class="col border p-1 text-center">
                                                            <div ngbDropdown class="btn-group dropdown">
                                                                <button type="button" ngbDropdownToggle data-bs-toggle="dropdown"
                                                                    aria-expanded="false" [disabled]="!condition.firstcolumn" class="dropdown-toggle btn btn-primary-light">{{
                                                                    (condition.secondcolumn ?
                                                                    condition.secondcolumn : 'Select Column') | slice:0:13 }}
                                                                </button>
                                                                <ul ngbDropdownMenu class="dropdown-menu drpdwnhgt">
                                                                    <li>
                                                                        <input class="form-control" type="text" [(ngModel)]="relation.searchTermT2"
                                                                            (input)="filterColumnsT2(relation)" placeholder="Search columns..." />
                                                                    </li>
                                                                    @for(table of relation.table2Data;track table){
                                                                    <li class="dropdown-plus-title">
                                                                        {{ table.schema }}.{{ table.alias }}
                                                                    </li>
                                                                    @for(column of table.columns;track column){
                                                                    <li><a class="dropdown-item" ngbDropdownItem
                                                                            (click)="condition.secondcolumn= column.column;condition.table2 = table.alias;relation.searchTermT2='';filterColumnsT2(relation);">{{
                                                                            column.column }}</a></li>
                                                                    }
                                                                    }
                                                                </ul>
                                                            </div>
                                                        </div>
                                                        @if(relation?.conditions?.length > 1){
                                                        <div class="col border p-1 text-center">
                                                            <a aria-label="anchor" (click)="deleteJoiningRelation(conditionIndex,relation, i)"
                                                                class="btn btn-icon btn-sm btn-danger-light btn-wave waves-effect waves-light">
                                                                <i class="ri-delete-bin-7-line" ngbTooltip="Delete Condition"></i>
                                                            </a>
                                                        </div>
                                                    }
                                                          </div>                                   
                                                    }
                                                <!-- </div> -->
                                                    <div class="mt-1 d-flex gap-2">
                                                        <button class="btn btn-primary mt-0" (click)="addNewCondition(relation);">Add new join... </button>
                                                        <button class="btn btn-primary mt-0" (click)="customTableJoin();">Join </button>
                                                    </div>
                                                <!-- </div> -->
                                            </div>
                                        </div>
                                        }
                                    </ul>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-12 col-md-12 p-1">
                    <div class="card-body p-1 ">
                        <div class="row p-1">
                            <div [@toggle]="isOpen ? 'open' : 'closed'"
                                class="table-joining-card p-0 col-xxl-6 col-xl-6 col-lg-6 col-md-6">

                                <div class="">
                                    <div class="card mb-0 border joining-T-H br-0" >
                                        <div class="card-header bg-light d-flex align-items-center justify-content-between p-4">
                                            <h6 class="m-0">Build Relation</h6>
                                            <i data-bs-toggle="tooltip" (click)="toggleCard()"
                                                ngbtooltip="fa fa-chevron-left"
                                                class="fa fa-chevron-left chevron-left-icon border-0"></i>
                                        </div>

                                        <div class="card-body">
                                            @if(isOpen){
                                            <div class=" gap-1 d-flex flex-wrap p-2">
                                                <div ngbDropdown class="btn-group my-2 dropdown">
                                                    <button type="button" ngbDropdownToggle data-bs-toggle="dropdown"
                                                        style="width: 124px;" aria-expanded="false"
                                                        class="dropdown-toggle btn btn-info-light"> {{(selectedClmnT1 ?
                                                        selectedClmnT1:'Select Column') | slice:0:13}}</button>
                                                    <ul ngbDropdownMenu class="dropdown-menu drpdwnhgt">
                                                        <li>
                                                            <input class="form-control" type="text" [(ngModel)]="searchTermT1" (input)="filterColumnsT1CrsDb()" placeholder="Search columns..." />                                                          
                                                        </li>
                                                        @for(table of crossDbFilteredTablesT1;track table){
                                                        <li class="dropdown-plus-title">
                                                            {{table.table}}.({{ table.schema }})
                                                        </li>
                                                        @for(column of table.columns;track column){
                                                        <li>
                                                            <a ngbDropdownItem class="dropdown-item"
                                                                (click)="selectedClmnT1 = column.column;getSelectedT1 = table.table;selectedAliasT1 = table.alias;selectedSchema1 = table.schema;updateRemainingTables(table)">{{
                                                                column.column }}</a>
                                                        </li>
                                                        }
                                                        }
                                                    </ul>
                                                </div>
                                                <!-- <div ngbDropdown class="btn-group my-2 dropdown">
                                                    <button type="button" ngbDropdownToggle data-bs-toggle="dropdown"
                                                        style="width: 93px;" aria-expanded="false"
                                                        class="dropdown-toggle btn btn-info-light">{{ selectedJoin ?
                                                        selectedJoin : 'Condition' }}</button>
                                                    <ul ngbDropdownMenu class="dropdown-menu"
                                                        style="background-color: #ffffff;">
                                                        <li><a class="dropdown-item" (click)="selectedJoin = 'Left'"
                                                                ngbDropdownItem>Left</a></li>
                                                        <li><a class="dropdown-item" (click)="selectedJoin = 'Right'"
                                                                ngbDropdownItem>Right</a></li>
                                                        <li><a class="dropdown-item" (click)="selectedJoin = 'inner'"
                                                                ngbDropdownItem>Inner</a></li>
                                                        <li><a class="dropdown-item" (click)="selectedJoin = 'Self'"
                                                                ngbDropdownItem>Self</a></li>
                                                        <li><a class="dropdown-item"
                                                                (click)="selectedJoin = 'full Outer'"
                                                                ngbDropdownItem>Full Outer</a></li>
                                                    </ul>
                                                </div> -->
                                                <div ngbDropdown class="btn-group my-2 dropdown">
                                                    <button type="button" ngbDropdownToggle data-bs-toggle="dropdown"
                                                        style="width: 93px;" aria-expanded="false"
                                                        class="dropdown-toggle btn btn-info-light">{{ selectedCndn ?
                                                        selectedCndn : 'Operator' }}</button>
                                                    <ul ngbDropdownMenu class="dropdown-menu"
                                                        style="background-color: #ffffff;">
                                                        <li><a class="dropdown-item" (click)="selectedCndn = '='"
                                                                ngbDropdownItem>Equals</a></li>
                                                        <li><a class="dropdown-item" (click)="selectedCndn = '>'"
                                                                ngbDropdownItem>Greater than</a></li>
                                                        <li><a class="dropdown-item" (click)="selectedCndn = '<'"
                                                                ngbDropdownItem>Less than</a></li>
                                                        <li><a class="dropdown-item" (click)="selectedCndn = '>='"
                                                                ngbDropdownItem>Greater than equals</a></li>
                                                        <li><a class="dropdown-item" (click)="selectedCndn = '<='"
                                                                ngbDropdownItem>Less than equals</a></li>
                                                    </ul>
                                                </div>
                                                <div ngbDropdown class="btn-group my-2 dropdown">
                                                    <button type="button" ngbDropdownToggle data-bs-toggle="dropdown"
                                                        style="width: 124px;" aria-expanded="false"
                                                        [disabled]="!selectedClmnT1"
                                                        class="dropdown-toggle btn btn-info-light">{{ (selectedClmnT2 ?
                                                        selectedClmnT2 : 'Select Column') | slice:0:13 }}
                                                    </button>
                                                    <ul ngbDropdownMenu class="dropdown-menu drpdwnhgt">
                                                        <li>
                                                            <input class="form-control" type="text" [(ngModel)]="searchTermT2" (input)="filterColumnsT2(filteredTablesT2)" placeholder="Search columns..." />
                                                        </li>
                                                        @for(table of filteredTablesT2;track table){
                                                        <li class="dropdown-plus-title">
                                                            {{table.table}}.({{ table.schema }})
                                                        </li>
                                                        @for(column of table.columns;track column){
                                                        <li><a class="dropdown-item" ngbDropdownItem
                                                                (click)="selectedClmnT2= column.column;getSelectedT2 = table.table;selectedAliasT2 = table.alias;selectedSchema2 = table.schema">{{
                                                                column.column }}</a></li>
                                                        }
                                                        }
                                                    </ul>
                                                </div>
                                            </div>
                                            <div class="modal-footer border-0">
                                                <button class="btn btn-secondary" (click)="clearRelationCondns()"
                                                    aria-expanded="false">
                                                    clear
                                                </button>
                                                <button class="btn btn-primary" [disabled]="!selectedClmnT2"
                                                    (click)="buildRelation()" aria-expanded="false">
                                                    Join
                                                </button>
                                            </div>
                                            }



                                        </div>
                                    </div>
                                </div>

                            </div>
                            <div class="p-0"
                                [ngClass]="!crossDbId ? 'col-xxl-12 col-xl-12 col-lg-12 col-md-12 p-0':isOpen ? 'col-xxl-6 col-xl-6 col-lg-6 col-md-6 p-0':''">
                                <div class="card mb-0 border joining-T-H"  [ngClass]="isOpen ? 'right-card':''"
                                    [class.expanded]="!isOpen">
                                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            @if(crossDbId){
                                            @if(!isOpen){
                                            <i data-bs-toggle="tooltip" (click)="toggleCard()"
                                                ngbtooltip="fa fa-chevron-left" 
                                                class="fa fa-chevron-right chevron-right-icon p-2 border-0 ">
                                                <button class="TextTransform">
                                                    <p class="mb-0">Build Relation</p>
                                                </button>
                                            </i>
                                            }
                                            }
                                            <h6 class="mb-0 me-2">Result Preview</h6>
                                            <p *ngIf="qurtySetId != 0" class="border p-1 rounded-2 mb-0 bg-light">Showing {{showingRows}} rows of {{totalRows}}
                                            </p>
                                        </div>
                                        <div class="result-rows d-flex justify-content-end">

                                            @if(TabledataJoining){
                                                 <button class="btn btn-icon btn-outline-primary me-2" (click)="downloadExcel()" type="button">
                                                    <i class="fa fa-download"></i>
                                                </button>
                                            <input type="number" [(ngModel)]="rowLimit" id="input-text"
                                                (keydown.enter)="getJoiningTableData()" placeholder="rows"
                                                class="form-control w-30" min="0">
                                            <a [class.disabled]="!rowLimit || rowLimit <= 0"
                                                [style.pointer-events]="!rowLimit || rowLimit <= 0 ? 'none' : 'auto'"
                                                (click)="getJoiningTableData()"><i
                                                    class="mdi mdi-arrow-right-thick result-icon"></i></a>
                                            <app-insights-button [buttonName]="' Go to sheet '"
                                                [classesList]="'btn btn-primary ms-2'" [previledgeId]="17"
                                                [isBtn]="true" [gotoSheetButton]="gotoSheetButtonDisable"
                                                (btnClickEvent)="goToSheet('fromtablejoining')" [isIcon]="false"></app-insights-button>
                                            }
                                        </div>
                                    </div>
                                    <div class="card-body d-flex align-items-center justify-content-center p-0">
                                        @if(TabledataJoining.length){
                                        <h6 class="fs-12 mt-2 mb-0 drag-txt">Result preview</h6>
                                        }@else{
                                        <div class="table-responsive Result-preview-table-h" 
                                            [class.table-left]="crossDbId && !isOpen"
                                            [class.table-right]="crossDbId && isOpen">
                                            <table
                                                class="table border text-nowrap text-md-nowrap table-striped table-bordered mb-0 ">
                                                <thead class="Result-preview-table-sticky">
                                                    <tr>
                                                        @for(data of TabledataJoining.column_data;track data){
                                                        <th>{{data}}</th>
                                                        }
                                                    </tr>
                                                </thead>
                                                <tbody>

                                                    @for(rowss of TabledataJoining.row_data;track rowss;){
                                                    <tr>
                                                        @for(rowdata of rowss;track rowdata;let i = $index){

                                                        <td>{{rowdata}}</td>
                                                        }
                                                    </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                        }
                                    </div>
                                    <div class="modal-footer border-0 p-1 mb-2 me-2">
                                        @if(qryTime){
                                        <span class="fetched-card"> <i class="fa fa-table"></i> fetched in <span
                                                class="time">{{qryTime}}s</span> Rows effected:{{qryRows}}</span>
                                        }
                                        <!-- @if(qurtySetId && qurtySetId){
                                        <app-insights-button [buttonName]="' Go to sheet '" [classesList]="'btn btn-primary'" [previledgeId]="17" [isBtn]="true"
                                            (btnClickEvent)="goToSheet()" [isIcon]="false"></app-insights-button>
                                        } -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    }
    @if(customSql){
    <div class="row main-container">
        <div class="col-xxl-2 col-xl-2 col-lg-2 col-md-2 p-1 card mb-2 mt-1 border">
            <div class="p-2 br-0 mb-0 border-bottom d-block ">
                <div class="d-flex align-items-center justify-content-between ">
                    <h6 class="mb-0">Connections</h6>
                    <a ngbTooltip="Click to connect multi datasources" (click)="goToConnections()"><span class="add-txt text-info">Add</span></a>
                </div>
                <p class=" mb-0" ngbTooltip="{{hostName}}">{{hostName | slice:0:15}}</p>
            </div>
            <div class="p-2 br-0 mb-0 border-bottom d-block ">
                <h6 class="mb-0">Database</h6>
                <p class="mb-0">{{databaseName}}</p>
            </div>
            <div class="card mb-0 mt-1 br-0 customSql-dropdown-menu-h">
                <div class="sidebar">
                    @for(menu of schematableList;track menu){
                    <div class="menu-item">

                        <div class="menu-title" class="" (click)="toggleSubMenu(menu)">
                            <span class="arrow d-flex">
                                @if(menu.expanded){
                                <i class="fa fa-chevron-down custom-chevron-down"></i>
                                }@else{
                                <i class="fa fa-chevron-right custom-chevron-right"></i>
                                }
                                <h6 class="text-truncate">{{ menu.schema }}</h6>
                            </span>

                        </div>
                        @if(menu.expanded){
                        <div class="sub-menu">
                            @for(submenu of menu?.tables;track submenu){
                            <div class="sub-menu-item example-box subMenuFlex">
                                <i class="fa fa-table" style="padding-right: 10px;"></i> <span>{{ submenu.table
                                    }}</span>
                            </div>
                            }
                        </div>
                        }
                    </div>
                    }
                </div>

            </div>
        </div>
        <div class="col-xl-10 col-md-12 p-1">
            <div class="card-body p-0 ">
                <div class="card mb-0 border customSql-tile-parent-h">
                    <div class="card-header bg-light d-flex align-items-center justify-content-between">
                        <div class="flex-grow-1">
                            <input type="text" (change)="markDirty()" placeholder="Title" [(ngModel)]="saveQueryName"
                                aria-label="Sheet" class="form-control">
                        </div>
                        <div class="right">
                            <a *ngIf="!fromSavedQuery" class="btn btn-blue-light m-1"
                                (click)=backToTableJoining()>Back to Table Joining</a>
                                @if(custmQryTime){
                            <a data-bs-effect="effect-super-scaled" data-bs-toggle="modal"
                                (click)="openSuperScaled(applyFiltersModal);getFilteredList('fromcustomsql')"
                                class="modal-effect btn btn-primary m-1">
                                <i class="fa fa-filter"></i> Apply Filters
                            </a>
                                }
                        </div>
                    </div>
                    <div class="card-body p-2">
                        <!-- <h6 class="fs-12 mt-2 mb-0 drag-txt">Enter your query here</h6> -->
                        <textarea class="query-text query-text-h" [(ngModel)]="sqlQuery" placeholder="Enter your SQL query here"></textarea>

                    </div>
                    <div class="modal-footer p-1 me-4 border-0">
                        <!-- <app-insights-button *ngIf="!updateQuery" [buttonName]="' Save Query '" [classesList]="'btn btn-primary'"
                                    [previledgeId]="51" [isBtn]="true" (btnClickEvent)="saveQuery()" [isIcon]="false"></app-insights-button> -->
                        <app-insights-button *ngIf="updateQuery" [buttonName]="' Update Query '"
                            [classesList]="'btn btn-primary'" [previledgeId]="52" [isBtn]="true"
                            (btnClickEvent)="updateCustmQuery()" [isIcon]="false"></app-insights-button>
                        <button *ngIf="!updateQuery" aria-expanded="false" class="btn btn-primary" [disabled]="!sqlQuery.length"
                            (click)="executeQuery()"> Run Query </button>
                        <button aria-expanded="false" class="btn btn-secondary" (click)="clrQuery()"> Clear Query
                        </button>
                    </div>
                </div>
                <div class="col-xl-12 col-md-12 p-0 mt-1">
                    <div class="card mb-0 border customsql-result-preview-h" >
                        <div class="card-header bg-light d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <h6 class="mb-0 me-2">Result Preview</h6>
                                <p *ngIf="custmQryTime" class="border mb-0 bg-light">Showing
                                    {{showingRowsCustomQuery}} rows of {{totalRowsCustomQuery}}</p>
                            </div>
                            <div class="result-rows d-flex justify-content-end">

                                @if(custmQryTime){
                                    <!-- <button class="btn btn-primary me-2" (click)="downloadExcelFromCustomSql()">
                                        <i class="fa fa-download"></i> Download
                                    </button>  -->
                                    <button class="btn btn-icon btn-outline-primary me-2" (click)="downloadExcelFromCustomSql()" type="button">
                                        <i class="fa fa-download"></i>
                                    </button>
                                <input type="number" [(ngModel)]="rowLimit" id="input-text"
                                    (keydown.enter)="executeQuery()"
                                    placeholder="rows" class="form-control w-30" min="0">
                                <a (click)="executeQuery()"><i
                                        class="mdi mdi-arrow-right-thick result-icon me-2"></i></a>
                                <app-insights-button [buttonName]="' Go to sheet '" [classesList]="'btn btn-primary'"
                                    [previledgeId]="17" [isBtn]="true" (btnClickEvent)="goToSheet('fromcustomsql')"
                                    [isIcon]="false"></app-insights-button>
                                }
                            </div>
                        </div>
                        <div class="card-body d-flex align-items-center justify-content-center p-0">

                            <div *ngIf="cutmquryTable" class="table-responsive"
                                style="overflow-y: auto;height: 233px;">
                                <table
                                    class="table border text-nowrap text-md-nowrap table-striped table-bordered mb-0">
                                    <thead class="Result-preview-table-sticky">
                                        <tr>
                                            @for(data of cutmquryTable.column_data;track data){
                                            <th>{{data}}</th>
                                            }
                                        </tr>

                                    </thead>
                                    <tbody>
                                        @for(rowss of cutmquryTable.row_data;track rowss;){
                                        <tr>
                                            @for(rowdata of rowss;track rowdata;let i = $index){

                                            <td>{{rowdata}}</td>
                                            }
                                        </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                            <!-- } -->
                        </div>
                        <div class="modal-footer border-0">
                            @if(custmQryTime){
                            <span class="fetched-card"> <i class="fa fa-table"></i> fetched in <span
                                    class="time">{{custmQryTime}} </span>,Rows effected:{{custmQryRows}}</span>
                            }
                            <!-- @if(qurtySetId && qurtySetId){
                                        <app-insights-button [buttonName]="' Go to sheet '" [classesList]="'btn btn-primary'" [previledgeId]="17" [isBtn]="true"
                                                (btnClickEvent)="goToSheet()" [isIcon]="false"></app-insights-button>
                                    } -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    }


    <ng-template #content let-modal>
        <!-- table column filter -->
        @if(tableColumnFilter){
        <div class="modal-header">
            <h6 class="modal-title">Filters (select Column)</h6>
            <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')">
            </button>
        </div>
        <div class="modal-body p-0">
            <div class="input-group">
                <input type="text" class="form-control border-end-0 " placeholder="Search" [(ngModel)]="columnSearch"
                    (keyup.enter)="callColumnWithTable()" aria-describedby="button-addon2">
                <button class="btn btn-primary border me-2 search-icon-border-radius" (click)="callColumnWithTable()" type="button"
                    id="button-addon2" ><i class="fe fe-search "></i></button>
            </div>
            <div class="table-responsive" style="max-height: 210px;">
                <table class="table table-bordered text-nowrap mb-0 custom-table">
                    @if(columnWithTablesData?.length){
                    <tbody>
                        @for(column of columnWithTablesData;track column){
                        <tr class="border-bottom user-list">
                            <td class="cursor-pointer" (click)="selectedColumnGetRows(column.column,column.data_type)"
                               >{{ column.column }} ({{column.data_type}}) </td>
                        </tr>
                        }
                    </tbody>
                    }@else{
                    <h6>No data in selected column</h6>
                    }
                </table>
            </div>
        </div>



        <div class="modal-footer">
            <button type="button" class="btn ripple btn-secondary"
                (click)="columnSearch = '';modal.close('Save click')">
                Close
            </button>
        </div>
        }
        <!-- column Data filter -->
        @if(columnRowFilter){
        <div class="modal-header">
            <h6 class="modal-title"> Data Filter</h6>
            <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click');columnDataSearch =''">
            </button>
        </div>
        <div class="modal-body p-0">
            <div class="input-group">
                <input type="text" class="form-control border-end-0 " placeholder="Search"
                    [(ngModel)]="columnDataSearch" (keyup.enter)="seachColumnDataFilter()"
                    aria-describedby="button-addon2">
                <button class="btn btn-primary border me-2 search-icon-border-radius" (click)="seachColumnDataFilter()" type="button"
                    id="button-addon2"><i class="fe fe-search "></i></button>
            </div>
            <!-- <div class="table-responsive" style="max-height: 210px;">
                <table class="table table-bordered text-nowrap mb-0 custom-table">
                    @if(searchFiltereredData?.length){
                    <thead>
                        <tr>
                            <td>
                                <div class="form-check">
                                    <input type="checkbox" id="selectAll" [(ngModel)]="isAllSelected"
                                        (change)="toggleAllRows($event)" class="form-check-input">
                                </div>
                            </td>
                            <td>
                                <label for="selectAll" class="form-check-label">Select All</label>
                            </td>
                        </tr>
                    </thead>
                    <tbody>
                        <cdk-virtual-scroll-viewport itemSize="40" class="viewport" style="height: 210px; width: 100%; display: contents;">
                            <tr *cdkVirtualFor="let row of searchFiltereredData; trackBy: trackByFn">
                                <td style="width: 46px;">
                                    <div class="form-check">
                                        <input type="checkbox" [id]="'defaultCheck' + row.id"
                                        [(ngModel)]="row.selected" 
                                            (change)="updateSelectedRows()"
                                            class="form-check-input">
                                    </div>
                                </td>
                                <td>
                                    <label [for]="'defaultCheck' + row.id" class="form-check-label">
                                        {{ row.label }}
                                    </label>
                                </td>
                            </tr>
                        </cdk-virtual-scroll-viewport>
                    </tbody>
                    }@else{
                    <h6>No data in selected column</h6>
                    }
                </table>
            </div> -->
            <div class="table-responsive" style="max-height: 210px; overflow: hidden;">
                <table class="table table-bordered text-nowrap mb-0 custom-table">
                    @if(searchFiltereredData?.length){
                    <tbody>
                        <div class="d-flex align-items-center">
                            <div class="col-1 p-1 border-end">
                                <div class="form-check">
                                    <input type="checkbox" id="selectAll" [(ngModel)]="isAllSelected"
                                        (change)="toggleAllRows($event)" class="form-check-input">
                                </div>
                            </div>
                            <div class="col-11 p-1 border-end">
                                <label for="selectAll" class="form-check-label">Select All</label>
                            </div>
                        </div>
                        <tr>
                         <td colspan="2" class="p-0">
                            <cdk-virtual-scroll-viewport itemSize="40" class="viewport" style="height: 210px; ">
                                <div class="d-flex align-items-center" *cdkVirtualFor="let row of searchFiltereredData; trackBy: trackByFn">
                                    <div class="col-1 p-1  border-end border-bottom">
                                        <div class="form-check m-0">
                                            <input type="checkbox" [id]="'defaultCheck' + row.id"
                                            [(ngModel)]="row.selected" 
                                                (change)="updateSelectedRows()"
                                                class="form-check-input">
                                        </div>
                                    </div>
                                    <div class="col-11 p-1 border-bottom border-end">
                                        <label [for]="'defaultCheck' + row.id" class="form-check-label">
                                            {{ row.label }}
                                        </label>
                                    </div>
                                </div>
                            </cdk-virtual-scroll-viewport>
                        </td>
                        </tr>
                    </tbody>
                    }@else{
                    <h6>No data in selected column</h6>
                    }
                </table>
            </div>
        </div>

        <div class="modal-footer">
            <div class="col text-left p-0">
                <input type="checkbox" id="exclude" class="form-check-input" [(ngModel)]="isExclude">
                <label for="exclude" class="form-check-label">Exclude</label>
            </div>
            <button type="button" (click)="getSelectedRows()" [disabled]="!isAnyRowSelected()"
                class="btn ripple btn-primary">Filter Data</button>
            <button type="button" class="btn ripple btn-secondary" (click)="modal.close('Save click');columnDataSearch =''">
                Close
            </button>
        </div>
        }
    </ng-template>



    <ng-template #applyFiltersModal let-modal>
        <div class="modal-header p-2">
            <h6 class="modal-title">Filters</h6>
            <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')">
            </button>
        </div>
        <div class="modal-body p-0">
            <div class="table-responsive" style="max-height: 210px;">
                <table class="table table-bordered text-nowrap mb-0 custom-table">
                    <tbody>
                        @for(data of filteredList;track data){
                        <tr class="border-bottom user-list">
                            <td>{{data.column_name }} </td>
                            <td>
                                <div class="hstack justify-content-center fs-1">
                                    <a aria-label="anchor"
                                        (click)="editFilter(data.filter_id);openSuperScaled(editFilters)"
                                        class="btn btn-icon btn-sm btn-info-light btn-wave waves-effect waves-light">
                                        <i class="ri-edit-line"></i></a>
                                    <a aria-label="anchor" (click)="deleteFilter(data.filter_id)"
                                        class="btn btn-icon btn-sm btn-danger-light btn-wave waves-effect waves-light"
                                        style="margin-left: 4px;">
                                        <i class="ri-delete-bin-7-line"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>

        </div>
        <div class="modal-footer">
            <button type="button" class="btn ripple btn-primary"
                (click)="openSuperScaledGetColunmns(content)">Add</button>
            <button type="button" class="btn ripple btn-secondary" (click)="modal.close('Save click')">
                Close
            </button>
        </div>
    </ng-template>

    <ng-template #editFilters let-modal>
        <div class="modal-header">
            <h6 class="modal-title">Edit Filters</h6>
            <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')">
            </button>
        </div>
        <div class="modal-body p-0">
            <!-- @for(rows of editFilterList;track rows;let i = $index){
                <div class="form-check">
                    <input type="checkbox" [id]="'defaultCheck' + i"  name="rows{{i}}"[(ngModel)]="rows.selected" class="form-check-input">    <label for="defaultCheck1" class="form-check-label"> {{ rows.label }} </label>
                </div>
              }  -->
            <div class="input-group">
                <input type="text" class="form-control border-end-0 " placeholder="Search"
                    [(ngModel)]="columnDataSearch" (keyup.enter)="seachColumnDataFilterEdit()"
                    aria-describedby="button-addon2">
                <button class="btn btn-primary border me-2 search-icon-border-radius" (click)="seachColumnDataFilterEdit()" type="button"
                    id="button-addon2"><i class="fe fe-search "></i></button>
            </div>
            <div class="table-responsive" style="max-height: 210px;overflow: hidden;">
                <table class="table table-bordered text-nowrap mb-0 custom-table">
                    <tbody>
                        <div class="d-flex align-items-center">
                            <div class="col-1 p-1 border-end">
                                <div class="form-check">
                                    <input type="checkbox" id="selectAll" [(ngModel)]="isAllSelected"
                                        (change)="toggleEditAllRows($event)" class="form-check-input">
                                </div>
                            </div>
                            <div class="col-11 p-1 border-end">
                                <label for="selectAll" class="form-check-label">Select All</label>
                            </div>
                        </div>
                        <tr>
                        <td colspan="2" class="p-0">
                        <cdk-virtual-scroll-viewport itemSize="40" class="viewport" style="height: 210px;">
                            <div class="d-flex align-items-center" *cdkVirtualFor="let row of searchEditFilterList; trackBy: trackByFn">
                                <div class="col-1 p-1  border-end border-bottom">    
                                <div class="form-check m-0">
                                        <input type="checkbox" [id]="'defaultCheck' + row.id"
                                        [(ngModel)]="row.selected" 
                                            (change)="updateEditSelectedRows()"
                                            class="form-check-input">
                                    </div>
                                    </div>
                                    <div class="col-11 p-1 border-bottom border-end">
                                        <label [for]="'defaultCheck' + row.id" class="form-check-label">
                                        {{ row.label }}
                                    </label>
                                </div>
                            </div>
                        </cdk-virtual-scroll-viewport>
                        </td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>
        <div class="modal-footer">
            <div class="col text-left p-0">
                <input type="checkbox" id="exclude" class="form-check-input" [(ngModel)]="isExclude">
                <label for="exclude" class="form-check-label">Exclude</label>
            </div>
            <button type="button" class="btn ripple btn-primary" [disabled]="!isAnyEditRowSelected()"
                (click)="getSelectedRowsFromEdit()">Apply</button>
            <button type="button" class="btn ripple btn-secondary" (click)="columnDataSearch = '';
            this.columnSearch = '';modal.close('Save click')">
                Close
            </button>
        </div>
    </ng-template>
    <ng-template #viewQueryModal let-modal>
        <div id="largemodal" tabindex="-1" role="dialog">
            <div class=" modal-lg " role="document">
                <div class="modal-header">
                    <h6 class="modal-title">Query</h6>
                </div>
                <div class="modal-body viewQuery-hgt">

                    <div class="form-group select2-sm">
                        <p>{{queryBuilt}}</p>
                    </div>
                </div>
                <div class="modal-footer">

                    <button type="button" class="btn ripple btn-secondary" (click)="modal.close('Save click')">
                        close
                    </button>
                    <button type="button" class="btn ripple btn-primary"
                        (click)="copyQuery(); modal.close('Save click')">Copy <i class="fa fa-copy"></i></button>
                </div>
            </div>
        </div>
    </ng-template>

    <ng-template #sheetcontainer></ng-template>