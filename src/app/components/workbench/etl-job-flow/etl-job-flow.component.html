<div class="main-container container-fluid mt-5">
    <div class="row ">
        <div class="col-md-12 mt-4">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between  align-items-center m-2">
                        <div>
                            <h5 class="card-title mb-0">ETL Job Flow</h5>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="d-lg-flex d-block">
                        <div class="col-2 p-1 border-end" [ngStyle]="{ 'display': isOpen ? 'block' : 'none' }">
                            <div class="card mb-0 connections-layer-h">
                                <ul ngbNav #nav="ngbNav" [(activeId)]="active" class="nav flex-column nav-pills" id="vertical-tab" role="tablist" aria-orientation="vertical">
                                    <li [ngbNavItem]="1">
                                        <div ngbAccordion [closeOthers]="true" class="accordion border-0" id="accordionExample">
                                            <div ngbAccordionItem [collapsed]="false" class="accordion-item">
                                                <h2 ngbAccordionHeader class="accordion-header" id="headingOne">
                                                    <button ngbAccordionButton class="accordion-button py-3 px-3" type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                                        <img src="./assets/images/etl/dataFlow_Instance-etl.svg" alt="Data Flow Instance" class="drawflow-image me-2">Data Flow Instance
                                                    </button>
                                                </h2>
                                                <div ngbAccordionCollapse id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne"
                                                    data-bs-parent="#accordionExample">
                                                    <div class="accordion-body p-0" ngbAccordionBody>
                                                        <ng-template>
                                                            <div class="data-cdk-tables px-3 mt-2">
                                                                <div class="drag-drawflow" draggable="true" (dragstart)="onDragStart($event, 'dataFlow', connectionList)" data-node="postgresSQL">
                                                                    <img src="./assets/images/etl/PostgreSQL-etl.svg" alt="postgresSQL" class="drawflow-image"><span> postgresSQL</span>
                                                                </div>
                                                            </div>
                                                        </ng-template>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div ngbAccordion [closeOthers]="true" class="accordion border-0" id="accordionExample">
                                            <div ngbAccordionItem [collapsed]="true" class="accordion-item">
                                                <h2 ngbAccordionHeader class="accordion-header" id="headingOne">
                                                    <button ngbAccordionButton class="accordion-button py-3 px-3" type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                                        <img src="./assets/images/etl/jobs-etl.svg" alt="Jobs" class="drawflow-image me-2">Jobs
                                                    </button>
                                                </h2>
                                                <div ngbAccordionCollapse id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne"
                                                    data-bs-parent="#accordionExample">
                                                    <div class="accordion-body p-0" ngbAccordionBody>
                                                        <ng-template>
                                                            <div class="data-cdk-tables px-3 mt-2">
                                                                <div class="drag-drawflow" draggable="true" (dragstart)="onDragStart($event, 'taskCommand', null)" data-node="Task Command">
                                                                    <img src="./assets/images/etl/task_command-etl.svg" alt="Task Command" class="drawflow-image"><span> Task Command</span>
                                                                </div>
                                                                <div class="drag-drawflow" draggable="true" (dragstart)="onDragStart($event, 'dbCommand', null)" data-node="DB Command">
                                                                    <img src="./assets/images/etl/db_command-etl.svg" alt="DB Command" class="drawflow-image"><span> DB Command</span>
                                                                </div>
                                                                <div class="drag-drawflow" draggable="true" (dragstart)="onDragStart($event, 'loop', null)" data-node="Loop">
                                                                    <img src="./assets/images/etl/loop-etl.svg" alt="Loop" class="drawflow-image"><span> Loop</span>
                                                                </div>
                                                                <div class="drag-drawflow" draggable="true" (dragstart)="onDragStart($event, 'emailNotification', null)" data-node="Email Notification">
                                                                    <img src="./assets/images/etl/email-etl.svg" alt="Email Notification" class="drawflow-image"><span> Email Notification</span>
                                                                </div>
                                                            </div>
                                                        </ng-template>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <ng-template ngbNavContent>
                                                <div id="drawflow" #drawflow [ngClass]="isOpen ? 'drawflow-width-half' : 'drawflow-width-full'" (drop)="onDrop($event)" (dragover)="onDragOver($event)">
                                                    <div class="bar-zoom">
                                                        <i class="fas fa-search-minus" (click)="canvasZoomOut()"></i>
                                                        <i class="fas fa-search" (click)="canvasZoomReset()"></i>
                                                        <i class="fas fa-search-plus" (click)="canvasZoomIn()"></i>
                                                    </div>
                                                </div>
                                        </ng-template>
                                    </li>
                                    <!-- <li [ngbNavItem]="2">
                                        <a ngbNavLink class="p-3 TabShadow">Job Flow</a>
                                        <ng-template ngbNavContent>
                                            <div id="drawflow" #drawflow [ngClass]="isOpen ? 'drawflow-width-half' : 'drawflow-width-full'" (drop)="onDrop($event)" (dragover)="onDragOver($event)">
                                            </div>
                                        </ng-template>
                                    </li> -->
                                </ul>
                            </div>
                           
                        </div>
                        <div class="col-10 py-0">
                            <!-- <div type="button" class="card mb-0 hide-show-btn btn-primary" (click)="isOpen = !isOpen">
                                <i *ngIf="isOpen" class="fa fa-angle-left fs-18"></i>
                                <i *ngIf="!isOpen" class="fa fa-angle-right fs-18"></i>
                            </div> -->
                            <div class="d-flex justify-content-end mb-2">
                                <input type="text" placeholder="Job Flow Name" class="form-control me-1" [(ngModel)]="etlName">
                                <button *ngIf="!dataFlowId" type="button" class="btn btn-primary me-1 iconProperties" style="width: 60px;" [disabled]="!etlName" (click)="saveOrUpdateEtlDataFlow()">Save</button>
                                <button *ngIf="dataFlowId" type="button" class="btn btn-primary me-1 iconProperties" style="width: 60px;" [disabled]="!etlName" (click)="saveOrUpdateEtlDataFlow()">update</button>
                                <!-- <button type="button" class="btn btn-primary me-1 iconProperties" (click)="getDataFlowLogs()">Export</button> -->
                                <button type="button" class="btn btn-primary me-1 iconProperties" style="width: 60px;" [disabled]="!isRunEnable" (click)="runDataFlow()">Run</button>
                                <!-- <button type="button" class="btn btn-primary me-1 iconProperties" style="width: 60px;" [disabled]="!isRefrshEnable" (click)="getDataFlowStatus(runId)">Refresh</button> -->
                            </div>
                            <div class="container-vertical">
                                <div class="top-pane" [ngbNavOutlet]="nav"></div>
                                <div *ngIf="isNodeSelected" class="card mb-0 border customsql-result-preview-h mt-3 resizable-bottom" [ngClass]="isCollapsed ? 'table-collapse':''" resizableTop>
                                    <div class="resize-handle"></div>
                                    <div class="card-body p-0 border rounded-3 tab-menu-heading tab-menu-heading-boxed">
                                        <div class="card-header bg-light d-flex align-items-center justify-content-between tabs-menu-boxed">
                                            <ul ngbNav #tableTypes="ngbNav" [(activeId)]="tableTypeTabId" class="nav panel-tabs fs-14 pb-1">
                                                <li [ngbNavItem]="1"> 
                                                    <a ngbNavLink class="p-3 TabShadow"> {{isCanvasSelected ? etlName : selectedNode.data.nodeData.general.name}} </a>
                                                    <ng-template ngbNavContent>
                                                        <div class="d-flex">
                                                            <div class="border-end node-table-left">
                                                                <ul ngbNav #tableTabs="ngbNav" [(activeId)]="tableTabId" class="nav flex-column nav-pills" id="vertical-tab"
                                                                    role="tablist" aria-orientation="vertical">
                                                                    @if(!isCanvasSelected){
                                                                    <li *ngIf="selectedNode.data.type !== 'loop_end'" [ngbNavItem]="1" className="nav-link text-start" id="general-tab"><a ngbNavLink>General</a>
                                                                        <ng-template ngbNavContent>
                                                                            <div class="tab-pane" id="years" role="tabpanel" aria-labelledby="years-tab" tabindex="0"
                                                                                style="height: 100%;">
                                                                                <div class="col-xl-12 col-lg-12 col-md-12 row g-0">
                                                                                    <div class="form-group w-100">
                                                                                        <label for="name" class="fw-bold">Name</label>
                                                                                        <div class="d-flex">
                                                                                            <div class="col-4 p-0">
                                                                                                <input type="text" id="name" name="name" [(ngModel)]="nodeName"
                                                                                                    class="form-control shadow-sm" (blur)="updateNode('general')" />
                                                                                            </div>
                                                                                            <span class="bg-primary d-flex align-items-center justify-content-center" style="width: 30px;"
                                                                                                (click)="updateNode('general')"><i class="fa fa-chevron-right text-light fs-5"></i></span>
                                                                                        </div><br>
                                                                                        <ng-container *ngIf="selectedNode.data.type === 'loop'">
                                                                                            <label for="parameterName" style="font-weight: bold;">Parameter Name</label><br>
                                                                                            <input type="text" disabled class="form-control shadow-sm" id="parameterName" name="parameterName" style="width: 40%;"><br>
                                                                                        </ng-container>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </ng-template>
                                                                    </li>
                                                                    <li [ngbNavItem]="2" className="nav-link text-start" id="properties-tab"><a ngbNavLink>Properties</a>
                                                                        <ng-template ngbNavContent>
                                                                            <div class="tab-pane " id="quarters" role="tabpanel" aria-labelledby="quarters-tab" tabindex="0">
                                                                                <div class="col-xl-12 col-lg-12 col-md-12">
                                                                                    <div *ngIf="selectedNode.data.type === 'loop'">
                                                                                        <label style="font-weight: bold;"> Type </label><br>
                                                                                        <select class="form-select" style="width: 40%;">
                                                                                            <option value="sql">SQL</option>
                                                                                            <option value="command">Command</option>
                                                                                            <option value="list">List</option>
                                                                                            <option value="remote_command">Remote Command</option>
                                                                                        </select><br>

                                                                                        <label for="command" style="font-weight: bold;"> Command </label><br>
                                                                                        <div class="d-flex">
                                                                                            <textarea id="command" name="command" rows="3"></textarea>
                                                                                            <span class="bg-primary d-flex align-items-center justify-content-center" style="width: 30px;" (click)="openExpressionEdit(expressionEdit, 'command', null)">
                                                                                                <i class="fa fa-chevron-right text-light" style="font-size: 20px;"></i>
                                                                                            </span>
                                                                                        </div><br>
                                                                                        <label style="font-weight: bold;"> Return Type </label><br>
                                                                                        <select class="form-select" style="width: 40%;">
                                                                                            <option *ngFor="let type of returnTypes; track type" [value]="type"> {{type}} </option>
                                                                                        </select><br>

                                                                                        <label for="delimiter" style="font-weight: bold;"> Delimiter </label><br>
                                                                                        <input type="text" class="form-control shadow-sm" id="delimiter" name="delimiter" style="width: 40%;"><br>

                                                                                        <label for="delimiter" style="font-weight: bold;"> Iteration Mode </label><br>
                                                                                        <input type="radio" id="sequential" name="delimiter"> <label for="sequential">Sequential</label> <br>
                                                                                        <input type="radio" id="parallel" name="delimiter"> <label for="parallel">Parallel</label> <br>

                                                                                        <input type="checkbox" id="fail" name="fail">
                                                                                        <label for="fail"> Fail if zero rows Returned</label>
                                                                                    </div>
                                                                                    <div *ngIf="selectedNode.data.type === 'emailNotification'">
                                                                                        <label for="to" style="font-weight: bold;"> To </label><br>
                                                                                        <div class="d-flex">
                                                                                            <textarea id="to" name="to" rows="3"></textarea>
                                                                                            <span class="bg-primary d-flex align-items-center justify-content-center" style="width: 30px;" (click)="openExpressionEdit(expressionEdit, 'to', null)">
                                                                                                <i class="fa fa-chevron-right text-light" style="font-size: 20px;"></i>
                                                                                            </span>
                                                                                        </div><br>

                                                                                        <label for="cc" style="font-weight: bold;"> CC </label><br>
                                                                                        <div class="d-flex">
                                                                                            <textarea id="cc" name="cc" rows="3"></textarea>
                                                                                            <span class="bg-primary d-flex align-items-center justify-content-center" style="width: 30px;" (click)="openExpressionEdit(expressionEdit, 'cc', null)">
                                                                                                <i class="fa fa-chevron-right text-light" style="font-size: 20px;"></i>
                                                                                            </span>
                                                                                        </div><br>

                                                                                        <label for="subject" style="font-weight: bold;"> Subject </label><br>
                                                                                        <div class="d-flex">
                                                                                            <textarea id="subject" name="subject" rows="3"></textarea>
                                                                                            <span class="bg-primary d-flex align-items-center justify-content-center" style="width: 30px;" (click)="openExpressionEdit(expressionEdit, 'subject', null)">
                                                                                                <i class="fa fa-chevron-right text-light" style="font-size: 20px;"></i>
                                                                                            </span>
                                                                                        </div><br>

                                                                                        <label for="attachment" style="font-weight: bold;">Attachment</label><br>
                                                                                        <input type="text" class="form-control shadow-sm" id="attachment" name="attachment" style="width: 40%;"><br>

                                                                                        <button> server</button><br>

                                                                                        <label for="Message" style="font-weight: bold;"> Message </label><br>
                                                                                        <div class="d-flex">
                                                                                            <textarea id="Message" name="Message" rows="3"></textarea>
                                                                                            <span class="bg-primary d-flex align-items-center justify-content-center" style="width: 30px;" (click)="openExpressionEdit(expressionEdit, 'Message', null)">
                                                                                                <i class="fa fa-chevron-right text-light" style="font-size: 20px;"></i>
                                                                                            </span>
                                                                                        </div><br>
                                                                                    </div>
                                                                                    <div *ngIf="selectedNode.data.type === 'dataFlow'">
                                                                                        <label style="font-weight: bold;"> Logging Level </label><br>
                                                                                        <select class="form-select" style="width: 40%;">
                                                                                            <option value="error">ERROR</option>
                                                                                            <option value="warn">WARN</option>
                                                                                            <option value="info">INFO</option>
                                                                                            <option value="debug">DEBUG</option>
                                                                                             <option value="trace">TRACE</option>
                                                                                        </select><br>

                                                                                        <label style="font-weight: bold;"> TForm Cleanup </label><br>
                                                                                        <select class="form-select" style="width: 40%;">
                                                                                            <option value="yes">Yes</option>
                                                                                            <option value="no">No</option>
                                                                                        </select><br>

                                                                                        <label style="font-weight: bold;"> JDBC Transform Control </label><br>
                                                                                        <select class="form-select" style="width: 40%;">
                                                                                            <option value="yes">Yes</option>
                                                                                            <option value="no">No</option>
                                                                                        </select><br>
                                                                                    </div>
                                                                                    <div *ngIf="['taskCommand', 'dbCommand', 'loop', 'email', 'dataFlow'].includes(selectedNode.data.type)">
                                                                                        <ng-container *ngIf="selectedNode.data.type === 'taskCommand'">
                                                                                            <label for="successCodes" style="font-weight: bold;"> Success Code(s) </label><br>
                                                                                            <input type="text" class="form-control shadow-sm" value="0, 99" id="successCodes" name="successCodes" style="width: 40%;"><br>
                                                                                        </ng-container>

                                                                                        <input type="checkbox" id="retryEnable" name="retryEnable">
                                                                                        <label for="retryEnable"> Retry Enabled</label>
                                                                                    </div>
                                                                                     <div *ngIf="selectedNode.data.type === 'loop_end'">
                                                                                        <label for="looperStartJob" style="font-weight: bold;">Looper Start Job</label><br>
                                                                                        <input type="text" disabled class="form-control shadow-sm" id="looperStartJob" name="looperStartJob" style="width: 40%;" [(ngModel)]="selectedNode.data.nodeData.general.name"><br>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </ng-template>
                                                                    </li>
                                                                    <li *ngIf="['taskCommand', 'dbCommand'].includes(selectedNode.data.type)" [ngbNavItem]="3" className="nav-link text-start" id="command-tab"><a ngbNavLink>Command</a>
                                                                        <ng-template ngbNavContent>
                                                                            <div class="tab-pane " id="quarters" role="tabpanel" aria-labelledby="quarters-tab" tabindex="0">
                                                                                <div class="col-xl-12 col-lg-12 col-md-12">
                                                                                    <div *ngIf="selectedNode.data.type === 'taskCommand'">
                                                                                        <label style="font-weight: bold;"> Command Type </label><br>
                                                                                        <select class="form-select" style="width: 40%;">
                                                                                            <option value="external">External</option>
                                                                                            <option value="fileWatcher">File Watcher</option>
                                                                                            <option value="jsonFileSpilt">JSON File Split</option>
                                                                                        </select><br>

                                                                                        <label for="command" style="font-weight: bold;"> Command </label><br>
                                                                                        <div class="d-flex">
                                                                                            <textarea id="command" name="command" rows="3"></textarea>
                                                                                            <span class="bg-primary d-flex align-items-center justify-content-center" style="width: 30px;" (click)="openExpressionEdit(expressionEdit, 'command', null)">
                                                                                                <i class="fa fa-chevron-right text-light" style="font-size: 20px;"></i>
                                                                                            </span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div *ngIf="selectedNode.data.type === 'dbCommand'">
                                                                                        <input type="checkbox" id="runDBCommand" name="runDBCommand">
                                                                                        <label for="runDBCommand"> Run DB Command From File</label><br>

                                                                                        <input type="checkbox" id="continueExecution" name="continueExecution">
                                                                                        <label for="continueExecution"> Continue execution on failure</label><br>

                                                                                        <label for="dbCommand" style="font-weight: bold;"> DB Command </label><br>
                                                                                        <div class="d-flex">
                                                                                            <textarea id="dbCommand" name="dbCommand" rows="3"></textarea>
                                                                                            <span class="bg-primary d-flex align-items-center justify-content-center" style="width: 30px;" (click)="openExpressionEdit(expressionEdit, 'dbCommand', null)">
                                                                                                <i class="fa fa-chevron-right text-light" style="font-size: 20px;"></i>
                                                                                            </span>
                                                                                        </div><br>

                                                                                        <label style="font-weight: bold;"> DB Command Output File </label><br>
                                                                                        <select class="form-select" style="width: 40%;">
                                                                                            <option value="external">$$SrcFileDir</option>
                                                                                            <option value="fileWatcher">$$TgtFileDir</option>
                                                                                        </select><br>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </ng-template>
                                                                    </li>
                                                                    <li *ngIf="selectedNode.data.type === 'dbCommand'" [ngbNavItem]="4" className="nav-link text-start" id="data-points-tab"><a ngbNavLink>Data Points</a>
                                                                        <ng-template ngbNavContent>
                                                                            <div class="tab-pane " id="quarters" role="tabpanel" aria-labelledby="quarters-tab" tabindex="0">
                                                                                <div class="col-xl-12 col-lg-12 col-md-12">
                                                                                    <div>
                                                                                        <label> Data Point: sample_35 </label><br>
                                                                                        <label> Data Point Schema: demo_456 </label>
                                                                                    </div>
                                                                                </div> 
                                                                            </div>
                                                                        </ng-template>
                                                                    </li>
                                                                    <li *ngIf="selectedNode.data.type === 'dataFlow'" [ngbNavItem]="5" className="nav-link text-start" id="data-points-tab"><a ngbNavLink>Connections</a>
                                                                        <ng-template ngbNavContent>
                                                                            <div class="tab-pane " id="quarters" role="tabpanel" aria-labelledby="quarters-tab" tabindex="0">
                                                                                <div class="col-xl-12 col-lg-12 col-md-12">
                                                                                    <div>
                                                                                        
                                                                                    </div>
                                                                                </div> 
                                                                            </div>
                                                                        </ng-template>
                                                                    </li>
                                                                    <li *ngIf="selectedNode.data.type === 'dataFlow'" [ngbNavItem]="6" className="nav-link text-start" id="data-points-tab"><a ngbNavLink>DataFlow Transforms</a>
                                                                        <ng-template ngbNavContent>
                                                                            <div class="tab-pane " id="quarters" role="tabpanel" aria-labelledby="quarters-tab" tabindex="0">
                                                                                <div class="col-xl-12 col-lg-12 col-md-12">
                                                                                    <div>
                                                                                        
                                                                                    </div>
                                                                                </div> 
                                                                            </div>
                                                                        </ng-template>
                                                                    </li>
                                                                    <li *ngIf="selectedNode.data.type === 'dataFlow'" [ngbNavItem]="7" className="nav-link text-start" id="data-points-tab"><a ngbNavLink>DataFlow Parameters</a>
                                                                        <ng-template ngbNavContent>
                                                                            <div class="tab-pane " id="quarters" role="tabpanel" aria-labelledby="quarters-tab" tabindex="0">
                                                                                <div class="col-xl-12 col-lg-12 col-md-12">
                                                                                    <div>
                                                                                        
                                                                                    </div>
                                                                                </div> 
                                                                            </div>
                                                                        </ng-template>
                                                                    </li>
                                                                    } @else{
                                                                    <li [ngbNavItem]="8" className="nav-link text-start" id="parameter-tab"><a ngbNavLink>Parameters</a>
                                                                        <ng-template ngbNavContent>
                                                                            <div class="tab-pane " id="quarters" role="tabpanel" aria-labelledby="quarters-tab" tabindex="0">
                                                                                <div class="col-xl-12 col-lg-12 col-md-12">
                                                                                    @if(canvasData?.parameters?.length > 0){
                                                                                    <div class="d-flex justify-content-end align-items-center gap-2 mb-3">
                                                                                        <button class="btn btn-sm btn-primary d-flex align-items-center" ngbTooltip="Add"
                                                                                            [triggers]="'hover'" (click)="addNewParameter()">
                                                                                            <i class="fa fa-plus me-1"></i> Add
                                                                                        </button>
                                                                                        <div class="input-group input-group-sm" style="max-width: 200px; height: 29px;">
                                                                                            <input type="text" class="form-control" placeholder="Search" [(ngModel)]="parameterSearchTerm"/>
                                                                                            <span class="input-group-text bg-primary" ngbTooltip="Search" [triggers]="'hover'">
                                                                                                <i class="fa fa-search text-light"></i>
                                                                                            </span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div style="height: 240px; overflow-y: auto;" class="table-responsive table-responsive-height">
                                                                                        <table class="table table-bordered table-striped text-nowrap mb-0">
                                                                                            <thead class="Result-preview-table-sticky table-light sticky-top">
                                                                                                <tr>
                                                                                                    <th>#</th>
                                                                                                    <th>Param Name</th>
                                                                                                    <th>Data Type</th>
                                                                                                    <th>Default</th>
                                                                                                    <th>Action</th>
                                                                                                </tr>
                                                                    
                                                                                            </thead>
                                                                                            <tbody>
                                                                                                @for(parameter of canvasData?.parameters | dataFlowSearchFilter:parameterSearchTerm:'paramName' ; track parameter; let i = $index){
                                                                                                <tr>
                                                                                                    <td>{{ i + 1 }}</td>
                                                                                                    <td><input type="text" class="form-control"
                                                                                                            [(ngModel)]="parameter.paramName" (blur)="updateNode('parameter')" /></td>
                                                                                                    <td>
                                                                                                        <select class="form-select" [(ngModel)]="parameter.dataType"
                                                                                                            (change)="updateNode('parameter')">
                                                                                                            <option value="" selected disabled>Select</option>
                                                                                                            <option *ngFor="let type of dataTypes" [value]="type">{{ type }}</option>
                                                                                                        </select>
                                                                                                    </td>
                                                                                                    <td>
                                                                                                        <div class="input-group">
                                                                                                            <input type="text" class="form-control" [(ngModel)]="parameter.default"
                                                                                                                (blur)="updateNode('parameter')" />
                                                                                                            <span class="input-group-text bg-primary" ngbTooltip=""
                                                                                                                (click)="openExpressionEdit(expressionEdit, parameter, i)">
                                                                                                                <i class="fa-solid fa-up-right-from-square"></i>
                                                                                                            </span>
                                                                                                        </div>
                                                                                                    </td>
                                                                                                    <td style="display: flex; align-items: center; justify-content: center;">
                                                                                                        <button class="btn btn-outline-danger" ngbTooltip="Delete" [triggers]="'hover'"
                                                                                                            (click)="deleteParameter(i)">
                                                                                                            <i class="fa fa-trash"></i>
                                                                                                        </button>
                                                                                                    </td>
                                                                                                </tr>
                                                                                                }
                                                                                            </tbody>
                                                                                        </table>
                                                                                    </div>
                                                                                    } @else{
                                                                                    <div class="d-flex">
                                                                                        <span>No Parameter exists, to add </span> &nbsp;
                                                                                        <button class="btn btn-sm btn-primary d-flex align-items-center" ngbTooltip="Add Attribute"
                                                                                            [triggers]="'hover'" (click)="addNewParameter()">
                                                                                            <i class="fa fa-plus me-2"></i> Click Here
                                                                                        </button>
                                                                                    </div>
                                                                                    }
                                                                                </div>
                                                                            </div>
                                                                        </ng-template>
                                                                    </li>
                                                                    <li [ngbNavItem]="9" className="nav-link text-start" id="SQL-Parametere-tab"><a
                                                                            ngbNavLink>SQL Parameters</a>
                                                                        <ng-template ngbNavContent>
                                                                            <div class="tab-pane " id="quarters" role="tabpanel" aria-labelledby="quarters-tab" tabindex="0">
                                                                                <div class="col-xl-12 col-lg-12 col-md-12">
                                                                                    @if(canvasData?.sqlParameters?.length > 0){
                                                                                    <div class="d-flex justify-content-end align-items-center gap-2 mb-3">
                                                                                        <button class="btn btn-sm btn-primary d-flex align-items-center" ngbTooltip="Add"
                                                                                            [triggers]="'hover'" (click)="addNewSQLParameter()">
                                                                                            <i class="fa fa-plus me-1"></i> Add
                                                                                        </button>
                                                                                        <div class="input-group input-group-sm" style="max-width: 200px; height: 29px;">
                                                                                            <input type="text" class="form-control" placeholder="Search" />
                                                                                            <span class="input-group-text bg-primary" ngbTooltip="Search" [triggers]="'hover'">
                                                                                                <i class="fa fa-search text-light"></i>
                                                                                            </span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div style="height: 240px; overflow-y: auto;" class="table-responsive table-responsive-height">
                                                                                        <table class="table table-bordered table-striped text-nowrap mb-0">
                                                                                            <thead class="Result-preview-table-sticky table-light sticky-top">
                                                                                                <tr>
                                                                                                    <th>#</th>
                                                                                                    <th>Param Name</th>
                                                                                                    <th>Data Type</th>
                                                                                                    <th>SQL</th>
                                                                                                    <th>Default</th>
                                                                                                    <th>Action</th>
                                                                                                </tr>
                                                                    
                                                                                            </thead>
                                                                                            <tbody>
                                                                                                @for(parameter of canvasData?.sqlParameters; track parameter; let i = $index){
                                                                                                <tr>
                                                                                                    <td>{{ i + 1 }}</td>
                                                                                                    <td><input type="text" class="form-control"
                                                                                                            [(ngModel)]="parameter.paramName" (blur)="updateNode('parameter')" /></td>
                                                                                                    <td>
                                                                                                        <select class="form-select" [(ngModel)]="parameter.dataType"
                                                                                                            (change)="updateNode('parameter')">
                                                                                                            <option value="" selected disabled>Select</option>
                                                                                                            <option *ngFor="let type of dataTypes" [value]="type">{{ type }}</option>
                                                                                                        </select>
                                                                                                    </td>
                                                                                                    <td>
                                                                                                        <div class="input-group">
                                                                                                            <input type="text" class="form-control" [(ngModel)]="parameter.sql"
                                                                                                                (blur)="updateNode('parameter')" />
                                                                                                            <span class="input-group-text bg-primary" ngbTooltip=""
                                                                                                                (click)="openExpressionEdit(expressionEdit, parameter, i)">
                                                                                                                <i class="fa-solid fa-up-right-from-square"></i>
                                                                                                            </span>
                                                                                                        </div>
                                                                                                    </td>
                                                                                                    <td><input type="text" class="form-control" [(ngModel)]="parameter.default"
                                                                                                            (blur)="updateNode('parameter')" /></td>
                                                                                                    <td>
                                                                                                        <button class="btn btn-outline-danger" ngbTooltip="Delete" [triggers]="'hover'"
                                                                                                            (click)="deleteSQLParameter(i)">
                                                                                                            <i class="fa fa-trash"></i>
                                                                                                        </button>
                                                                                                    </td>
                                                                                                </tr>
                                                                                                }
                                                                                            </tbody>
                                                                                        </table>
                                                                                    </div>
                                                                                    } @else{
                                                                                    <div class="d-flex">
                                                                                        <span>No SQL Parameter exists, to add </span> &nbsp;
                                                                                        <button class="btn btn-sm btn-primary d-flex align-items-center" ngbTooltip="Add SQL Parameter"
                                                                                            [triggers]="'hover'" (click)="addNewSQLParameter()">
                                                                                            <i class="fa fa-plus me-2"></i> Click Here
                                                                                        </button>
                                                                                    </div>
                                                                                    }
                                                                                </div>
                                                                            </div>
                                                                        </ng-template>
                                                                    </li>
                                                                    <!-- <li [ngbNavItem]="10" className="nav-link text-start" id="load-order-tab"><a
                                                                            ngbNavLink>Load Order</a>
                                                                        <ng-template ngbNavContent>
                                                                        </ng-template>
                                                                    </li> -->
                                                                    }
                                                                </ul>
                                                            </div>
                                                        
                                                            <div class="p-2 node-table-right">
                                                                <div class="tab-content" id="vertical-tabContent">
                                                                    <div [ngbNavOutlet]="tableTabs"></div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </ng-template>
                                                </li>
                                                <li *ngIf="isLogShow" [ngbNavItem]="2" (click)="getDataFlowLogs(selectedNode.data.nodeData.general.name)"> <a ngbNavLink class="p-3 TabShadow"> Logs </a>
                                                    <ng-template ngbNavContent>
                                                        <app-etl-logger-view [logs]="logs"></app-etl-logger-view>
                                                    </ng-template>
                                                </li>
                                            </ul>
                                            <div type="button" class="btn btn-primary" (click)="toggleCollapse()">
                                                <i *ngIf="isCollapsed" class="fa fa-angle-up fs-18"></i>
                                                <i *ngIf="!isCollapsed" class="fa fa-angle-down fs-18"></i>
                                            </div>
                                            <!-- <div class="d-flex justify-content-end align-items-center me-1">
                                                <button class="btn btn-sm btn-primary" (click)="toggleCollapse()">
                                                    <i class="mdi" [ngClass]="isCollapsed ? 'mdi-chevron-down' : 'mdi-chevron-up'"></i>
                                                </button>
                                            </div> -->
                                        </div>
                                        <div class="d-flex">
                                            <div class="tab-content" id="vertical-tabContent" style="width: 100%;">
                                                <div [ngbNavOutlet]="tableTypes"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer p-3">
                    
                </div>
            </div>
        </div>
    </div>
</div>

<ng-template #connectionList let-modal>
    <div class="modal-header">
        <h6 class="modal-title">Data Flow Instace</h6>
        <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')">
        </button>
    </div>
    <div class="modal-body">
        <div class="panel panel-primary">
            <div class="tables-modal">
                <label for="connection">Select DataFlow <span class="text-danger">*</span></label>
                <ng-select [items]="dataFlowOptions" bindLabel="data_flow_name" placeholder="Select a dataFlow" [searchable]="true" 
                    [(ngModel)]="selectedDataFlow" name="dataFlow" id="dataFlow">
                </ng-select>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <div class="text-right">
            <button type="button" class="btn ripple btn-secondary me-2"
                (click)="modal.close('Cross click'); selectedDataFlow = null;">Cancel</button>
            <button type="button" [disabled]="!selectedDataFlow" class="btn ripple btn-primary" (click)="addNode(nodeToAdd, posX, posY); modal.dismiss('Save click')">Ok</button>
        </div>
    </div>
</ng-template>

<ng-template #expressionEdit let-modal>
    <div class="modal-header">
        <h5 class="modal-title">Expression Editor - {{(isParameter || isSQLParameter) ? etlName : selectedNode?.data?.nodeData?.general?.name}} ({{(isParameter || isSQLParameter) ? 'Data Flow' : selectedNode?.data?.type}}) </h5>
        <button type="button" class="btn-close text-light" aria-label="Close" (click)="modal.dismiss('Cross click'); isParameter = false; isSQLParameter = false; isJoinerCondition = false; isHaving = false; isWhere = false; isFilter = false;"></button>
    </div>

    <div class="modal-body p-3">

        <div class="mb-2 d-flex justify-content-between align-items-center">
            @if(isJoinerCondition || isHaving || isFilter || isWhere){
            <label class="form-label mb-0"><b>*{{selectedField}} (boolean)</b></label>
            } @else if(isParameter || isSQLParameter){
                <label class="form-label mb-0"><b>*{{selectedField?.paramName}} ({{selectedField?.dataType}})</b></label>
            } @else{
            <label class="form-label mb-0"><b>*{{selectedField?.attributeName}} ({{selectedField?.dataType}})</b></label>
            }
        </div>

        <div class="mb-3">
            <textarea #expressionTextarea class="form-control" rows="6" placeholder="Enter expression..." [(ngModel)]="expression"
                style="width: 100%;">
            </textarea>
        </div>

        <!-- TABLE WRAPPER -->
        <div>
            <table class="table table-bordered w-100">
                <thead>
                    <tr>
                        <th class="fw-bold bg-primary text-white">Transforms</th>
                        <th class="fw-bold bg-primary text-white"> {{selectedGroup}} </th>
                        <th class="fw-bold bg-primary text-white"> {{selectedColumn.attributeName || selectedColumn.label}} </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>

                        <!-- Transforms Column -->
                        <td class="align-top" style="width: 33%;">
                            <div style="max-height: 200px; overflow-y: auto;">
                                <div *ngFor="let group of groupedColumns | keyvalue" class="text-break py-1 px-2 hover-bg" style="cursor: pointer;" 
                                    [class.bg-primary]="selectedGroup === group.key" [class.text-white]="selectedGroup === group.key" (click)="selectedGroup = group.key">
                                    {{ group.key }}
                                </div>
                            </div>
                        </td>

                        <!-- Selected Transform -->
                        <td class="align-top" style="width: 33%;">
                            <input type="text" class="form-control form-control-sm mb-2" placeholder="Search fields..." [(ngModel)]="expEditorSearchTerm" />
                            <div style="max-height: 200px; overflow-y: auto;">
                                <div *ngFor="let column of (groupedColumns[selectedGroup] || []) | dataFlowSearchFilter:expEditorSearchTerm:'label'" class="text-break py-1 px-2 hover-bg" style="cursor: pointer;"
                                    (click)="selectedColumn = column; insertOrReplace(selectedGroup + '.' + column.label, expressionTextarea);">
                                    {{ column.label }}
                                </div>
                            </div>
                        </td>

                        <!-- Selected Column -->
                        <td class="align-top" style="width: 34%;">
                            <div *ngIf="selectedColumn">
                                <div><b>{{selectedColumn.attributeName || selectedColumn.label}}</b></div>
                                <div>Data type: {{selectedColumn.dataType}}</div>
                            </div>
                            <div *ngIf="!selectedField" class="text-muted">No column selected</div>
                        </td>

                    </tr>
                </tbody>
            </table>
        </div>

    </div>

    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.dismiss('cancel'); isParameter = false; isSQLParameter = false; isJoinerCondition = false; isHaving = false; isWhere = false; isFilter = false;">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="updateExpressionToNode(); modal.dismiss('Save click'); isParameter = false; isSQLParameter = false;">OK</button>
    </div>
</ng-template>
  